# otus_mlops_k8s_dags

Материалы к занятию №38 **«Поиск отклонений и сдвигов в данных / MLOps в k8s»**. 

## Пререквизиты

Предполагается, что у вас запущен кластер кубера. Это может быть кластер, которым вы можете управлять (*и который вам не жалко поломать*): например, – в облаке (YC) или кластер, запущенный локально с помощью соответствующей сборки (например, [kind](https://kind.sigs.k8s.io/) или [mimnikube](https://minikube.sigs.k8s.io/docs/)).

## Структура репозитория

* `apps/joke-api` – простое FastAPI-приложение, которое которое экспонирует ручку `api/v1/jokes`. Если за нее дернуть, вернется случайная выборка коротких и глупых текстов из файла `apps/joke-api/data/jokes.csv`;
* `apps/joke-to-s3` – приложение, которое обращается к `apps/joke-api`, получает json с выборкой текстов, преобразует его в csv и загружает его в `s3`.  
* `dags` – директория содержит скрипты DAG-ов для Airflow, который запущен к кластере кубера.
* `k8s` – директория содержит необходимые конфигурации для Airflow в кубере. 

## Подготовка

### joke-to-s3

Собираем Docker-образ c приложением:

```bash
docker build --platform linux/amd64 -t {ваш-логин-на-dokerhub}/joke-to-s3:v1 -f Dockerfile
```

Отправляем образ в [dockerhub](https://hub.docker.com/):

```bash
docker push {ваш-логин-на-dokerhub}/joke-to-s3:v1
```

### joke-api

Сервис должен быть запущен там, до куда под, запущенный в вашем кластере кубера, сможет дозвониться. Проще всего создать виртуальную машину в YC (самую слабую и дешевую) и развернуть сервис там:

1. Клонируете репозиторий;
1. Создаете виртуальное окружение python и устанавливаете в него пакеты из `apps/joke-api/requirements.txt`;
1. Запускаете FastAPI-сервис: `fastapi run main.py`

Если все получилось, то:

```bash
curl http://{публичный-IP-вашей-ВМ}:8000/api/v1/jokes
```

вернет json-простыню с текстами на кириллице.

## Конфигурация кубер-кластера



